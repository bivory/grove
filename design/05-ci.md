# grove - CI & Release

This document outlines the version management, continuous integration, and
release process for the grove project.

## 1. Overview

Grove uses a hybrid local/CI approach:

- **Developers** run version bumping locally via `cargo release`
- **CI** builds and packages binaries on tag push
- **GitHub Actions** handles testing on every PR and main branch push

## 2. Key Version Files

Three files must maintain synchronized version numbers:

| File | Purpose |
|------|---------|
| `Cargo.toml` | Rust package version (source of truth) |
| `.claude-plugin/plugin.json` | Claude Code plugin manifest version |
| `.claude-plugin/marketplace.json` | Plugin marketplace version (if published) |

## 3. CI Workflows

### 3.1 Pull Request Workflow

Triggers on every PR to `main`:

```yaml
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@nextest
      - uses: jdx/mise-action@v2

      - name: Format check
        run: mise run fmt:check

      - name: Clippy
        run: mise run clippy

      - name: Test
        run: mise run test

      - name: Typos
        run: mise run typos

      - name: Docs lint
        run: mise run docs:lint

      - name: Duplication check
        run: mise run dupes

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: jdx/mise-action@v2

      - name: Audit
        run: mise run audit

      - name: Deny
        run: mise run deny

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: jdx/mise-action@v2

      - name: Coverage
        run: mise run coverage

  platforms:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-13
            target: x86_64-apple-darwin

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: jdx/mise-action@v2

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Test
        run: mise run test
```

### 3.2 Release Workflow

Triggers on version tags (`v*`):

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: grove-linux-x86_64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact: grove-linux-arm64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: grove-darwin-arm64
          - os: macos-13
            target: x86_64-apple-darwin
            artifact: grove-darwin-x86_64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/grove dist/${{ matrix.artifact }}
          chmod +x dist/${{ matrix.artifact }}
          tar -czvf dist/${{ matrix.artifact }}.tar.gz -C dist ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}.tar.gz

  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify version sync
        run: |
          CARGO_VERSION=$(grep -m1 '^version' Cargo.toml | cut -d'"' -f2)
          PLUGIN_VERSION=$(jq -r .version .claude-plugin/plugin.json)
          echo "Cargo.toml version: $CARGO_VERSION"
          echo "plugin.json version: $PLUGIN_VERSION"
          if [ "$CARGO_VERSION" != "$PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi

  release:
    needs: [build, verify]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true
```

### 3.3 Nightly Workflow

Runs extended checks on a schedule:

```yaml
name: Nightly

on:
  schedule:
    - cron: '0 4 * * *'  # 4 AM UTC daily
  workflow_dispatch:

jobs:
  extended:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@beta
      - uses: jdx/mise-action@v2

      - name: Build (beta)
        run: cargo build --release

      - name: Test (beta)
        run: mise run test

      - name: Outdated dependencies
        run: mise run outdated

      - name: Full CI suite
        run: mise run ci
```

## 4. Version Synchronization

### 4.1 Sync Script

A bash script synchronizes version numbers across all files:

```bash
#!/bin/bash
# scripts/sync-plugin-version.sh
# Called as a cargo-release pre-release hook

set -euo pipefail

VERSION="$1"

# Update plugin.json
jq --arg v "$VERSION" '.version = $v' .claude-plugin/plugin.json > tmp.json
mv tmp.json .claude-plugin/plugin.json

# Update marketplace.json if it exists
if [ -f .claude-plugin/marketplace.json ]; then
  jq --arg v "$VERSION" '.version = $v' .claude-plugin/marketplace.json > tmp.json
  mv tmp.json .claude-plugin/marketplace.json
fi

# Stage the changes
git add .claude-plugin/*.json
```

### 4.2 cargo-release Configuration

`release.toml` configuration:

```toml
[workspace]
allow-branch = ["main"]
sign-commit = true
sign-tag = true
push = true
publish = false  # We don't publish to crates.io
tag-message = "Release {{version}}"
pre-release-commit-message = "chore: release {{version}}"

pre-release-hook = ["./scripts/sync-plugin-version.sh", "{{version}}"]
```

## 5. Release Process

### 5.1 Developer Commands

Use mise tasks for version bumping:

```bash
# Dry run (see what would happen)
mise run release:dry-run

# Release a patch version (0.1.0 -> 0.1.1)
mise run release:patch

# Release a minor version (0.1.0 -> 0.2.0)
mise run release:minor

# Release a major version (0.1.0 -> 1.0.0)
mise run release:major
```

### 5.2 Release Workflow

1. Developer runs `mise run release:patch` (or minor/major)
2. cargo-release:
   - Bumps version in `Cargo.toml`
   - Runs sync script to update plugin files
   - Creates a commit with all version changes
   - Tags the commit with `v{version}`
   - Pushes commit and tag to origin
3. GitHub Actions detects the tag push
4. Release workflow builds binaries for all platforms
5. Release is created with artifacts attached

### 5.3 Post-Release Verification

After a release, verify:

- [ ] GitHub release page shows all platform binaries
- [ ] Version numbers match in Cargo.toml and plugin.json
- [ ] CHANGELOG.md is updated (if maintained)
- [ ] Binary downloads and runs correctly

## 6. Build Targets

### 6.1 Supported Platforms

| Platform | Target Triple | CI | Binary Name |
|----------|---------------|-----|-------------|
| Linux x86_64 | x86_64-unknown-linux-gnu | Yes | grove-linux-x86_64 |
| Linux ARM64 | aarch64-unknown-linux-gnu | Yes | grove-linux-arm64 |
| macOS x86_64 | x86_64-apple-darwin | Yes | grove-darwin-x86_64 |
| macOS ARM64 | aarch64-apple-darwin | Yes | grove-darwin-arm64 |
| Windows | - | No | - |

### 6.2 Why No Windows

Grove depends on:

- Unix file permissions for atomic writes
- POSIX path conventions
- Integration with Claude Code (CLI-first workflow)

Windows support is not planned for the initial release.

## 7. Plugin Distribution

### 7.1 Installation Methods

1. **GitHub Releases** (primary)
   - Download binary for platform
   - Run install script or copy to PATH

2. **Plugin Marketplace** (future)
   - Publish to Claude Code plugin marketplace
   - One-click install via `claude install grove`

### 7.2 Install Script

`.claude-plugin/install.sh`:

```bash
#!/bin/bash
# Grove installer for Claude Code plugin

set -euo pipefail

VERSION="${GROVE_VERSION:-latest}"
INSTALL_DIR="${GROVE_INSTALL_DIR:-$HOME/.local/bin}"

# Detect platform
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

case "$OS-$ARCH" in
  linux-x86_64)  ARTIFACT="grove-linux-x86_64" ;;
  linux-aarch64) ARTIFACT="grove-linux-arm64" ;;
  darwin-x86_64) ARTIFACT="grove-darwin-x86_64" ;;
  darwin-arm64)  ARTIFACT="grove-darwin-arm64" ;;
  *)
    echo "Unsupported platform: $OS-$ARCH"
    exit 1
    ;;
esac

# Download and install
if [ "$VERSION" = "latest" ]; then
  URL="https://github.com/user/grove/releases/latest/download/${ARTIFACT}.tar.gz"
else
  URL="https://github.com/user/grove/releases/download/v${VERSION}/${ARTIFACT}.tar.gz"
fi

echo "Downloading grove from $URL..."
curl -fsSL "$URL" | tar -xz -C "$INSTALL_DIR"
chmod +x "$INSTALL_DIR/grove"

echo "Grove installed to $INSTALL_DIR/grove"
echo "Ensure $INSTALL_DIR is in your PATH"
```

## 8. Quality Gates

### 8.1 PR Requirements

All PRs must pass:

| Check | Tool | Threshold |
|-------|------|-----------|
| Format | `cargo fmt` | No diff |
| Lint | `cargo clippy` | No warnings (-D warnings) |
| Test | `cargo nextest` | All pass |
| Typos | `typos` | No typos |
| Docs | `markdownlint-cli2` | No errors |
| Duplication | `jscpd` | < 5% duplicated |
| Coverage | `cargo llvm-cov` | >= 70% lines |

### 8.2 Security Checks

Run on every PR:

| Check | Tool | Action on Failure |
|-------|------|-------------------|
| Audit | `cargo audit` | Block merge |
| Deny | `cargo deny` | Block merge |

### 8.3 Nightly Checks

Additional checks run nightly:

| Check | Tool | Action on Failure |
|-------|------|-------------------|
| Beta build | `cargo +beta build` | Notify (non-blocking) |
| Outdated | `cargo outdated` | Notify (non-blocking) |

## 9. Dependency Management

### 9.1 Update Policy

- **Patch versions**: Auto-merge via Dependabot
- **Minor versions**: Review and merge weekly
- **Major versions**: Manual review, test thoroughly

### 9.2 Dependabot Configuration

`.github/dependabot.yml`:

```yaml
version: 2
updates:
  - package-ecosystem: cargo
    directory: /
    schedule:
      interval: weekly
    groups:
      rust-deps:
        patterns:
          - "*"
    ignore:
      - dependency-name: "*"
        update-types: ["version-update:semver-major"]
```

### 9.3 License Compliance

`deny.toml` enforces license policy:

```toml
[licenses]
allow = [
  "MIT",
  "Apache-2.0",
  "BSD-2-Clause",
  "BSD-3-Clause",
  "ISC",
  "Zlib",
  "CC0-1.0",
  "Unlicense",
]

[bans]
multiple-versions = "warn"
wildcards = "deny"
```

## 10. Monitoring

### 10.1 CI Health

Track via GitHub Actions:

- Workflow success rate
- Average build time
- Flaky test detection

### 10.2 Release Health

Track via GitHub Releases:

- Download counts per platform
- Issue reports per version
- Time between releases

## Related Documents

- [Overview](./00-overview.md) - Vision, core concepts, design principles
- [Architecture](./01-architecture.md) - System diagrams, domain model, sequences
- [Implementation](./02-implementation.md) - Rust types, storage, hooks, CLI commands
- [Stats and Quality](./03-stats-and-quality.md) - Quality tracking model,
  retrieval scoring
- [Test Plan](./04-test-plan.md) - Testing strategy
